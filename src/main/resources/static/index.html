<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cofrinho Pro - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Vari√°veis de Cores e Temas */
        :root {
            --bg: #f0f2f5; --card: #ffffff; --primary: #3182ce;
            --success: #48bb78; --danger: #f56565; --text: #2d3748;
            --border: #e2e8f0; --input-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg: #1a202c; --card: #2d3748; --primary: #63b3ed;
            --success: #68d391; --danger: #feb2b2; --text: #f7fafc;
            --border: #4a5568; --input-bg: #1a202c;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: var(--text); transition: 0.3s; }
        .main-container { width: 100%; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr; gap: 20px; }

        /* Sidebar e Cards */
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; border: none; transition: 0.3s; }
        h3 { font-size: 0.85rem; margin-top: 0; color: var(--text); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; opacity: 0.8; }

        .theme-toggle { margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        .nav-btn { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid var(--border); border-radius: 50px; background: var(--input-bg); cursor: pointer; transition: 0.3s; font-weight: 600; color: var(--text); }
        .nav-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* Bot√£o Sair Especial */
        .btn-logout { margin-top: 20px; border-color: #e5e7eb; color: #a0aec0; }
        .btn-logout:hover { border-color: var(--danger); color: var(--danger); background: rgba(245, 101, 101, 0.1); }

        /* Grid de Moedas */
        .coin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .btn-coin { border: none; border-radius: 12px; color: white; padding: 12px 5px; font-weight: bold; cursor: pointer; font-size: 0.7rem; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .btn-coin:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* Cores Fixas */
        .c-real { background: #3182ce; } .c-dolar { background: #718096; } .c-euro { background: #48bb78; }
        .c-iene { background: #f56565; } .c-yuan { background: #ecc94b; } .c-rupia { background: #9f7aea; }
        .c-won { background: #ed8936; } .c-shekel { background: #4fd1c5; }

        input { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px; margin: 5px 0; box-sizing: border-box; background: var(--input-bg); color: var(--text); }
        .btn-action { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }

        /* Tabela e Layout */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--text); opacity: 0.6; font-size: 0.7rem; padding-bottom: 10px; }
        td { padding: 12px 5px; font-size: 0.85rem; border-bottom: 1px solid var(--border); color: var(--text); }
        .badge { padding: 3px 8px; border-radius: 50px; font-size: 0.65rem; color: #fff !important; font-weight: bold; }

        .hidden { display: none; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .detalhe-item { padding: 8px; background: var(--bg); border-radius: 8px; margin-bottom: 5px; font-size: 0.8rem; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="main-container">
    <aside>
        <div class="card">
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span> <span id="theme-text">Modo Escuro</span>
            </div>
            <h3>üè¶ Carteira</h3>
            <button class="nav-btn" onclick="toggleTotal()">Saldo Total (R$)</button>
            <div id="resultado-total" class="hidden" style="padding: 10px; margin-bottom: 10px; background: rgba(49, 130, 206, 0.1); text-align:center; font-weight:bold; color: var(--primary); border-radius: 10px;"></div>

            <button class="nav-btn" onclick="toggleDetalhes()">Ver Detalhes</button>
            <button class="nav-btn" onclick="document.getElementById('area-remocao').classList.toggle('hidden')">Retirar Valor</button>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
            <button class="nav-btn btn-logout" onclick="sair()">üö™ Sair</button>
        </div>

        <div id="card-detalhes" class="card hidden">
            <h3>Moeda do Pa√≠s</h3>
            <div id="lista-detalhes"></div>
        </div>

        <div id="area-remocao" class="card hidden">
            <h3 style="color: var(--danger)">Retirada</h3>
            <input type="number" id="id-remover" placeholder="ID da Moeda">
            <input type="text" id="valor-remover" placeholder="0,00" oninput="mask(this)" onkeydown="if(event.key==='Enter') executarRemocao()">
            <button class="btn-action" style="background: var(--danger)" onclick="executarRemocao()">Confirmar Retirada</button>
        </div>
    </aside>

    <main>
        <div class="row">
            <div class="card">
                <h3>Moedas no Cofrinho</h3>
                <div class="coin-grid" id="grid-moedas"></div>
                <div id="area-valor" class="hidden">
                    <input type="text" id="campo-valor" placeholder="Valor do Dep√≥sito" oninput="mask(this)" onkeydown="if(event.key==='Enter') depositar()">
                    <button class="btn-action" onclick="depositar()">Confirmar Dep√≥sito</button>
                </div>
            </div>
            <div class="card">
                <h3>Saldos em Real (R$)</h3>
                <canvas id="graficoBarra" height="150"></canvas>
            </div>
        </div>

        <div class="row" style="grid-template-columns: 320px 1fr;">
            <div class="card">
                <h3>Distribui√ß√£o</h3>
                <canvas id="graficoRosca"></canvas>
            </div>
            <div class="card">
                <h3>üìú Hist√≥rico de Transa√ß√µes</h3>
                <table>
                    <thead>
                    <tr><th>Moeda</th><th>Valor</th><th>A√ß√£o</th><th>Data/Hora</th></tr>
                    </thead>
                    <tbody id="tabela-corpo"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
    let selecionado = 0, gRosca, gBarra, moedasGlobais = [];

    const configMoedas = {
        'Real':   { cor: 'c-real',   simbolo: 'R$', taxa: 1, hex: '#3182ce' },
        'Dolar':  { cor: 'c-dolar',  simbolo: 'U$', taxa: 0.20, hex: '#718096' },
        'Euro':   { cor: 'c-euro',   simbolo: '‚Ç¨',  taxa: 0.18, hex: '#48bb78' },
        'Iene':   { cor: 'c-iene',   simbolo: '¬•',  taxa: 28.5, hex: '#f56565' },
        'Yuan':   { cor: 'c-yuan',   simbolo: '¬•',  taxa: 1.45, hex: '#ecc94b' },
        'Rupia':  { cor: 'c-rupia',  simbolo: '‚Çπ',  taxa: 16.5, hex: '#9f7aea' },
        'Won':    { cor: 'c-won',    simbolo: '‚Ç©',  taxa: 260, hex: '#ed8936' },
        'Shekel': { cor: 'c-shekel', simbolo: '‚Ç™',  taxa: 0.75, hex: '#4fd1c5' }
    };

    function toggleTheme() {
        const doc = document.documentElement;
        const isDark = doc.getAttribute('data-theme') === 'dark';
        doc.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('theme-icon').innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
        document.getElementById('theme-text').innerText = isDark ? 'Modo Escuro' : 'Modo Claro';
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
        if (moedasGlobais.length > 0) atualizarGraficos(moedasGlobais);
    }

    if (localStorage.getItem('theme') === 'dark') toggleTheme();

    function sair() {
        // Redireciona para a tela de login
        window.location.href = '/login';
    }

    async function carregar() {
        try {
            const rM = await fetch('/moedas/total');
            moedasGlobais = await rM.json();
            renderizarBotoes();
            atualizarGraficos(moedasGlobais);

            const rH = await fetch('/moedas/historico');
            const transacoes = await rH.json();
            const corpo = document.getElementById('tabela-corpo');
            corpo.innerHTML = "";
            transacoes.slice(0, 8).forEach(t => {
                const isDep = t.tipo === "DEP√ìSITO";
                corpo.innerHTML += `
                    <tr>
                        <td><b>${t.moedaNome}</b></td>
                        <td style="color:${isDep?'var(--success)':'var(--danger)'}">R$ ${t.valorAlterado.toFixed(2)}</td>
                        <td><span class="badge" style="background:${isDep?'#48bb78':'#f56565'}">${t.tipo}</span></td>
                        <td style="opacity: 0.6; font-size:0.7rem">${new Date(t.dataHora).toLocaleString('pt-BR')}</td>
                    </tr>`;
            });
        } catch (e) { console.error(e); }
    }

    function renderizarBotoes() {
        const grid = document.getElementById('grid-moedas');
        grid.innerHTML = "";
        moedasGlobais.forEach(m => {
            const conf = configMoedas[m.nome] || {cor: 'c-real', simbolo: '$', taxa: 1};
            const valorNaMoeda = m.valor * conf.taxa;
            grid.innerHTML += `<button class="btn-coin ${conf.cor}" onclick="preparar(${m.id})"><span style="font-size:0.6rem; opacity:0.8">ID: ${m.id}</span><span>${m.nome.toUpperCase()}</span><span class="coin-val">${conf.simbolo} ${valorNaMoeda.toFixed(2)}</span></button>`;
        });
    }

    function toggleTotal() {
        const div = document.getElementById('resultado-total');
        div.classList.toggle('hidden');
        if (!div.classList.contains('hidden')) {
            const total = moedasGlobais.reduce((acc, m) => acc + m.valor, 0);
            div.innerText = "Total: R$ " + total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
    }

    function toggleDetalhes() {
        const card = document.getElementById('card-detalhes');
        card.classList.toggle('hidden');
        if (!card.classList.contains('hidden')) {
            const lista = document.getElementById('lista-detalhes');
            lista.innerHTML = "";
            moedasGlobais.forEach(m => {
                const conf = configMoedas[m.nome] || {simbolo: '$', taxa: 1};
                const valorLocal = m.valor * conf.taxa;
                lista.innerHTML += `<div class="detalhe-item"><span>${m.nome}:</span><b>${conf.simbolo} ${valorLocal.toFixed(2)}</b></div>`;
            });
        }
    }

    function atualizarGraficos(dados) {
        const labels = dados.map(m => m.nome);
        const values = dados.map(m => m.valor);
        const colors = labels.map(l => configMoedas[l]?.hex || '#ccc');
        const textColor = document.documentElement.getAttribute('data-theme') === 'dark' ? '#f7fafc' : '#2d3748';
        Chart.defaults.color = textColor;

        if(gBarra) gBarra.destroy();
        gBarra = new Chart(document.getElementById('graficoBarra'), {
            type: 'bar', data: { labels, datasets:[{ data: values, backgroundColor: colors, borderRadius: 5 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: textColor } }, y: { ticks: { color: textColor } } } }
        });
        if(gRosca) gRosca.destroy();
        gRosca = new Chart(document.getElementById('graficoRosca'), {
            type: 'doughnut', data: { labels, datasets:[{ data: values, backgroundColor: colors, borderWeight: 0 }] },
            options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: textColor, boxWidth: 10, font: { size: 10 } } } } }
        });
    }

    function preparar(id) { selecionado = id; document.getElementById('area-valor').classList.remove('hidden'); document.getElementById('campo-valor').focus(); }
    function mask(i) { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2).replace(".", ","); i.value = v; }
    async function depositar() { const v = document.getElementById('campo-valor').value.replace(',','.'); if(!v || v == "0.00") return; await fetch(`/moedas/adicionar/${selecionado}?valor=${v}`); location.reload(); }
    async function executarRemocao() { const id = document.getElementById('id-remover').value; const v = document.getElementById('valor-remover').value.replace(',','.'); if(!id || !v || v == "0.00") return; await fetch(`/moedas/remover-valores/${id}?valor=${v}`); location.reload(); }

    window.onload = carregar;
</script>
</body>
</html>